---
# Phase 0: Clean up npm-based installation
- name: Check if npm-based Claude Code shim exists
  stat:
    path: "{{ lookup('env', 'HOME') }}/.local/share/mise/shims/claude"
  register: npm_claude_shim

- name: Check if npm-based Claude Code is installed via mise
  shell: mise list 2>/dev/null | grep -q '@anthropic-ai/claude-code'
  register: npm_claude_installed
  changed_when: false
  failed_when: false

- name: Uninstall npm-based Claude Code via mise
  shell: mise uninstall npm:@anthropic-ai/claude-code
  when: npm_claude_installed.rc == 0

- name: Remove npm Claude Code artifacts
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ lookup('env', 'HOME') }}/Library/Caches/claude-cli-nodejs"
    - "{{ lookup('env', 'HOME') }}/.local/share/mise/shims/claude"

# Find all mise Node.js version directories (actual installs, not symlinks)
- name: Find mise Node.js installation directories
  find:
    paths: "{{ lookup('env', 'HOME') }}/.local/share/mise/installs/node"
    file_type: directory
    recurse: false
  register: mise_node_dirs

- name: Filter actual Node.js installations (exclude symlinks)
  set_fact:
    mise_node_versions: "{{ mise_node_dirs.files | selectattr('islnk', 'equalto', false) | map(attribute='path') | list }}"

# Uninstall npm global claude-code from each mise Node.js version
- name: Uninstall npm global claude-code from mise Node.js versions
  shell: |
    if [ -x "{{ item }}/bin/npm" ]; then
      "{{ item }}/bin/npm" uninstall -g @anthropic-ai/claude-code 2>/dev/null || true
    fi
  loop: "{{ mise_node_versions }}"
  changed_when: false

- name: Find npm-installed Claude Code in mise Node.js installations
  find:
    paths: "{{ lookup('env', 'HOME') }}/.local/share/mise/installs/node"
    patterns: "claude-code"
    file_type: directory
    recurse: true
  register: npm_claude_dirs

- name: Remove npm-installed Claude Code packages
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ npm_claude_dirs.files }}"
  when: npm_claude_dirs.matched > 0

- name: Find npm Claude Code symlinks in mise Node.js bins
  find:
    paths: "{{ lookup('env', 'HOME') }}/.local/share/mise/installs/node"
    patterns: "claude"
    file_type: link
    recurse: true
  register: npm_claude_links

- name: Remove npm Claude Code symlinks
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ npm_claude_links.files }}"
  when: npm_claude_links.matched > 0

# Remove hidden .claude-* files and directories (from failed/partial installs)
- name: Find hidden .claude-* entries in mise Node.js installations
  find:
    paths: "{{ lookup('env', 'HOME') }}/.local/share/mise/installs/node"
    patterns: ".claude-*,.claude*"
    file_type: any
    recurse: true
    hidden: true
  register: hidden_claude_entries

- name: Remove hidden .claude-* entries
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ hidden_claude_entries.files }}"
  when: hidden_claude_entries.matched > 0

# Remove mise npm package installation directory
- name: Remove mise npm claude-code installation directory
  file:
    path: "{{ lookup('env', 'HOME') }}/.local/share/mise/installs/npm-anthropic-ai-claude-code"
    state: absent

# Clean up empty @anthropic-ai directories
- name: Find @anthropic-ai directories in mise Node.js installations
  find:
    paths: "{{ lookup('env', 'HOME') }}/.local/share/mise/installs/node"
    patterns: "@anthropic-ai"
    file_type: directory
    recurse: true
  register: anthropic_dirs

- name: Remove empty @anthropic-ai directories
  shell: |
    if [ -d "{{ item.path }}" ] && [ -z "$(ls -A '{{ item.path }}')" ]; then
      rm -rf "{{ item.path }}"
      echo "removed"
    else
      echo "skipped"
    fi
  loop: "{{ anthropic_dirs.files }}"
  when: anthropic_dirs.matched > 0
  register: remove_anthropic_result
  changed_when: "'removed' in remove_anthropic_result.stdout"

# Phase 1: Install via Native installer
- name: Check if Claude Code native binary exists
  stat:
    path: "{{ lookup('env', 'HOME') }}/.local/bin/claude"
  register: claude_native

- name: Ensure ~/.local/bin directory exists
  file:
    path: "{{ lookup('env', 'HOME') }}/.local/bin"
    state: directory
    mode: '0755'

- name: Install Claude Code via Native installer
  shell: curl -fsSL https://claude.ai/install.sh | bash
  args:
    creates: "{{ lookup('env', 'HOME') }}/.local/bin/claude"
  when: not claude_native.stat.exists

- name: Verify Claude Code installation
  shell: "{{ lookup('env', 'HOME') }}/.local/bin/claude --version"
  register: claude_version
  changed_when: false

- name: Display Claude Code version
  debug:
    var: claude_version.stdout_lines
